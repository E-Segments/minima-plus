<!-- Critical Code Block Styles (loads immediately to prevent jump) -->
<style>
  /* Pre-style ALL code blocks before Prism loads */
  pre, pre[class*="language-"] {
    position: relative;
    margin: 1.5rem 0;
    padding: 1.25rem 1.5rem 1.25rem 3.5rem; /* Reserve space for line numbers */
    border-radius: 0.75rem;
    background: #1e1e1e !important;
    font-size: 0.875rem;
    line-height: 1.7;
    overflow-x: auto;
    border: 1px solid #333;
    color: #d4d4d4;
    counter-reset: linenumber;
  }

  pre code, pre[class*="language-"] code {
    background: transparent !important;
    padding: 0 !important;
    font-size: inherit;
    color: inherit;
    border-radius: 0;
    display: block;
  }

  /* Dark mode */
  .dark pre, .dark pre[class*="language-"] {
    border-color: #444;
  }

  /* Line numbers - pre-styled before Prism */
  .line-numbers-rows {
    position: absolute;
    pointer-events: none;
    top: 1.25rem;
    left: 0;
    width: 3rem;
    font-size: 100%;
    letter-spacing: -1px;
    border-right: 1px solid #444;
    user-select: none;
    padding-right: 0.5rem;
    text-align: right;
  }

  .line-numbers-rows > span {
    display: block;
    counter-increment: linenumber;
  }

  .line-numbers-rows > span::before {
    content: counter(linenumber);
    color: #555;
    display: block;
  }

  /* Inline code */
  :not(pre) > code {
    background: #f1f5f9;
    color: #e11d48;
    padding: 0.2rem 0.4rem;
    border-radius: 0.25rem;
    font-size: 0.875em;
    font-weight: 500;
  }

  .dark :not(pre) > code {
    background: #334155;
    color: #fb7185;
  }

  /* Prose overrides */
  .prose pre {
    background: #1e1e1e !important;
    color: #d4d4d4;
  }

  .prose code::before,
  .prose code::after {
    content: none;
  }

  /* Copy button container */
  .code-block-wrapper {
    position: relative;
  }

  .copy-button {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background: #333;
    color: #ccc;
    border: none;
    padding: 0.4rem 0.6rem;
    border-radius: 0.375rem;
    font-size: 0.7rem;
    cursor: pointer;
    opacity: 0;
    transition: all 0.2s ease;
    z-index: 10;
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  .code-block-wrapper:hover .copy-button {
    opacity: 1;
  }

  .copy-button:hover {
    background: #444;
    color: #fff;
  }

  .copy-button.copied {
    background: #22c55e;
    color: white;
  }

  /* Language label */
  .code-language {
    position: absolute;
    top: 0.5rem;
    left: 0.75rem;
    color: #666;
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  /* Scrollbar */
  pre::-webkit-scrollbar {
    height: 8px;
  }

  pre::-webkit-scrollbar-track {
    background: #2d2d2d;
    border-radius: 4px;
  }

  pre::-webkit-scrollbar-thumb {
    background: #555;
    border-radius: 4px;
  }

  pre::-webkit-scrollbar-thumb:hover {
    background: #666;
  }

  /* Token colors - VS Code Dark+ inspired */
  .token.comment, .token.prolog, .token.doctype, .token.cdata { color: #6a9955; }
  .token.punctuation { color: #d4d4d4; }
  .token.property, .token.tag, .token.boolean, .token.number, .token.constant, .token.symbol, .token.deleted { color: #b5cea8; }
  .token.selector, .token.attr-name, .token.string, .token.char, .token.builtin, .token.inserted { color: #ce9178; }
  .token.operator, .token.entity, .token.url, .language-css .token.string, .style .token.string { color: #d4d4d4; }
  .token.atrule, .token.attr-value, .token.keyword { color: #569cd6; }
  .token.function, .token.class-name { color: #dcdcaa; }
  .token.regex, .token.important, .token.variable { color: #d16969; }
  .token.important, .token.bold { font-weight: bold; }
  .token.italic { font-style: italic; }
</style>

<!-- Prism.js (loads async to not block rendering) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" crossorigin="anonymous" />

<script>
(function() {
  // Wrap code blocks, add line numbers and copy button immediately (no waiting for Prism)
  function setupCodeBlocks() {
    const codeBlocks = document.querySelectorAll('pre');

    codeBlocks.forEach(function(pre) {
      // Skip if already wrapped
      if (pre.parentElement.classList.contains('code-block-wrapper')) return;

      // Get language and code element
      const code = pre.querySelector('code');
      let language = '';
      if (code) {
        const langClass = Array.from(code.classList).find(c => c.startsWith('language-'));
        if (langClass) {
          language = langClass.replace('language-', '');
        }
      }

      // Add line numbers class for Prism
      pre.classList.add('line-numbers');

      // Create line numbers immediately (before Prism loads)
      const codeText = code ? code.textContent : pre.textContent;
      const lineCount = codeText.split('\n').length;

      // Remove existing line numbers if any
      const existingLines = pre.querySelector('.line-numbers-rows');
      if (existingLines) existingLines.remove();

      // Create line numbers element
      const linesWrapper = document.createElement('span');
      linesWrapper.className = 'line-numbers-rows';
      linesWrapper.setAttribute('aria-hidden', 'true');
      for (let i = 0; i < lineCount; i++) {
        linesWrapper.appendChild(document.createElement('span'));
      }
      pre.appendChild(linesWrapper);

      // Create wrapper
      const wrapper = document.createElement('div');
      wrapper.className = 'code-block-wrapper';
      pre.parentNode.insertBefore(wrapper, pre);
      wrapper.appendChild(pre);

      // Add language label
      if (language) {
        const langLabel = document.createElement('span');
        langLabel.className = 'code-language';
        langLabel.textContent = language;
        wrapper.appendChild(langLabel);
      }

      // Add copy button
      const copyBtn = document.createElement('button');
      copyBtn.className = 'copy-button';
      copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg><span>Copy</span>';
      copyBtn.setAttribute('aria-label', 'Copy code');
      wrapper.appendChild(copyBtn);

      copyBtn.addEventListener('click', function() {
        const text = code ? code.textContent : pre.textContent;
        navigator.clipboard.writeText(text).then(function() {
          copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg><span>Copied!</span>';
          copyBtn.classList.add('copied');
          setTimeout(function() {
            copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg><span>Copy</span>';
            copyBtn.classList.remove('copied');
          }, 2000);
        });
      });
    });
  }

  // Run immediately if DOM ready, otherwise wait
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupCodeBlocks);
  } else {
    setupCodeBlocks();
  }
})();
</script>

<!-- Load Prism async for syntax highlighting (enhancement only, not required) -->
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup-templating.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-jsx.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-tsx.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-yaml.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-toml.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markdown.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-ruby.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-php.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-go.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-rust.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-docker.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js" crossorigin="anonymous"></script>

<script>
// Re-highlight when Prism loads (async)
window.addEventListener('load', function() {
  if (typeof Prism !== 'undefined') {
    // Map Jekyll language classes
    document.querySelectorAll('pre code').forEach(function(code) {
      const langMap = {
        'language-html': 'language-markup',
        'language-sh': 'language-bash',
        'language-shell': 'language-bash',
        'language-yml': 'language-yaml',
        'language-js': 'language-javascript',
        'language-ts': 'language-typescript',
      };

      code.classList.forEach(function(cls) {
        if (langMap[cls]) {
          code.classList.remove(cls);
          code.classList.add(langMap[cls]);
        }
      });
    });

    Prism.highlightAll();
  }
});
</script>
